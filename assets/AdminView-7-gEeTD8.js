import{d as de,u as ce,c as U,e as y,o as u,w as t,r as me,A as pe,g as r,h as fe,H as ge,I as ve,j as be,n as d,z as ye,p as Ce,q as ke,v as g,f as n,x as p,l,J as we,K as N,B as xe,G as m,i,t as c,C as Ae,D as Se,E as _e,L as Le,M as Ne,N as Ue,O as Ie,P as Ve}from"./index-CnDOF7Do.js";import{_ as F}from"./BAlert.vue_vue_type_script_setup_true_lang-BoLIpZFk-BMwzMJkR.js";import{d as j}from"./BCard.vue_vue_type_script_setup_true_lang-BAaV9t2h-CIFWF0FW.js";import{_ as $e,a as De}from"./BFormInput.vue_vue_type_script_setup_true_lang-B9E5yJEs-B8Rcxc3z.js";import{_ as Ee,C as Me}from"./CourseForm-B3_aL1fp.js";import{_ as Be}from"./BTable.vue_vue_type_script_setup_true_lang-BpEcqTUn-DWnsn5f9.js";import{u as ze}from"./courses-BUTPmGTd.js";const Fe=de({__name:"BButtonGroup",props:{ariaLabel:{default:"Group"},size:{default:"md"},tag:{default:"div"},vertical:{type:Boolean,default:!1}},setup(R){ge(ve,!0);const a=ce(R,"BButtonGroup"),I=U(()=>({"btn-group":!a.vertical,[`btn-group-${a.size}`]:a.size!=="md","btn-group-vertical":a.vertical}));return(E,f)=>(u(),y(fe(r(a).tag),{class:pe(I.value),role:"group","aria-label":r(a).ariaLabel},{default:t(()=>[me(E.$slots,"default")]),_:3},8,["class","aria-label"]))}}),Re={class:"d-flex justify-content-between align-items-center"},Pe={class:"d-flex gap-2"},Te={key:0,class:"text-center my-5"},Ge={key:0,class:"spinner-border spinner-border-sm me-2"},je={key:0,class:"spinner-border spinner-border-sm me-2"},Oe=["src","alt","onClick"],qe={key:1,class:"d-flex flex-column align-items-center justify-content-center text-muted",style:{width:"50px",height:"50px",background:"#f0f0f0","border-radius":"6px",cursor:"default","font-size":"10px","text-align":"center",padding:"2px"}},He={key:0,class:"spinner-border spinner-border-sm me-2"},he={key:0},Je={key:1},Ke={key:0,class:"spinner-border spinner-border-sm me-2"},Qe={class:"mb-0"},We={__name:"AdminView",setup(R){const P=xe(),a=ze(),I=ye(),E={profiles:()=>Ne(Ve,"userProfiles")},f=o=>typeof o=="string"&&o.trim().length>0;window.__coursesStore=a;const C=d(null),k=d(!1),w=d(!1),x=d(!1),A=d(null),M=d(!1),T=d(""),B=d(!1),S=d(null),O=o=>{S.value=o||null,B.value=!0},q=o=>{if(!o)return 0;const e=Number(o.cupos)||0,s=Number(o.inscritos)||0;return Math.max(0,e-s)},H=o=>{if(!o)return"Por confirmar";try{const e=new Date(o);return isNaN(e.getTime())?String(o):e.toLocaleDateString("es-CL",{year:"numeric",month:"short",day:"numeric"})}catch{return String(o)}},z=o=>{T.value=o,M.value=!0},h=U(()=>I.isAdmin),V=d(!1),_=d(""),v=d(null),J=async()=>{if(!_.value.trim()){v.value={type:"danger",message:"Ingresa un correo para continuar"};return}V.value=!0,v.value=null;try{const o=Le(E.profiles(),Ue("email","==",_.value.trim().toLowerCase())),s=(await Ie(o)).docs[0];if(!s){v.value={type:"danger",message:"No se encontrÃ³ un perfil con ese correo"};return}await I.updateUserRole({uid:s.id,role:"admin"}),v.value={type:"success",message:"Permisos de administrador asignados"},_.value=""}catch(o){console.error("[Admin] assignAdminRole error",o),v.value={type:"danger",message:"No se pudo actualizar el rol"}}finally{V.value=!1}},$=U(()=>a.allCourses.filter(o=>!f(o?.nombre)||!f(o?.img))),K=U(()=>$.value.length>0),L=d(!1),Q=async()=>{if(!(!$.value.length||L.value)){L.value=!0;try{for(const o of[...$.value])o?.id&&await a.deleteCourse(o.id);z("Cursos incompletos eliminados correctamente.")}catch(o){console.error("[Admin] removeIncompleteCourses error",o),alert("No fue posible eliminar los cursos incompletos. Intenta nuevamente.")}finally{L.value=!1}}},b=d({codigo:"",nombre:"",descripcion:"",precio:"",duracion:"",cupos:"",inscritos:0,estado:!0,img:""}),W=[{key:"img",label:"Imagen"},{key:"codigo",label:"CÃ³digo",sortable:!0},{key:"nombre",label:"Nombre",sortable:!0},{key:"duracion",label:"DuraciÃ³n"},{key:"precio",label:"Precio",sortable:!0},{key:"ocupacion",label:"OcupaciÃ³n"},{key:"estado",label:"Estado"},{key:"actions",label:"Acciones"}];U(()=>{const o=b.value,e=s=>typeof s=="number"&&!Number.isNaN(s);return f(o.codigo)&&f(o.nombre)&&f(o.descripcion)&&(e(o.precio)||typeof o.precio=="string"&&o.precio.trim()!=="")&&f(o.duracion)&&(e(o.cupos)||typeof o.cupos=="string"&&o.cupos.trim()!=="")&&f(o.img)});const X=o=>new Intl.NumberFormat("es-CL",{style:"decimal",minimumFractionDigits:0}).format(o),Y=o=>{b.value={...o}},G=()=>{b.value={codigo:"",nombre:"",descripcion:"",precio:"",duracion:"",cupos:"",inscritos:0,estado:!0,img:""}},Z=async(o,e)=>{if(!o||!o.id||a.isLoading)return;const s=await a.updateCourse(o.id,{estado:!!e});s&&s.success||alert("No fue posible actualizar el estado del curso")},ee=()=>{console.log("[UI] openAddForm called"),k.value=!0},oe=()=>{console.log("[UI] confirmAddCourse called"),k.value=!1,w.value=!0},se=async()=>{console.log("[UI] onConfirmAdd called"),w.value=!1,await Promise.resolve(),await re()},re=async()=>{console.log("[UI] addCourse called",JSON.parse(JSON.stringify(b.value)));const o={...b.value,precio:Number(b.value.precio)||0,cupos:Number(b.value.cupos)||0,inscritos:Number(b.value.inscritos)||0};try{const e=await a.addCourse(o);console.log("[UI] addCourse result",e),e&&e.success?(G(),k.value=!1,z("Curso agregado correctamente.")):alert("Error al agregar curso: "+(e?.error||"Error desconocido"))}catch(e){console.error("[UI] addCourse exception",e),alert("Error crÃ­tico al agregar curso")}},te=o=>{P.push(`/admin/edit/${o.id}`)},ae=o=>{A.value=o,x.value=!0},le=()=>{ne()},ne=async()=>{if(x.value=!1,!!A.value)try{const o=await a.deleteCourse(A.value.id);o&&o.success?z("Curso eliminado correctamente."):alert("Error al eliminar curso: "+(o?.error||"Error desconocido"))}finally{A.value=null}},ie=[{codigo:"0001",nombre:"HTML",estado:!0,precio:3e4,duracion:"1 mes",descripcion:"curso html",cupos:10,inscritos:0,img:"https://www.w3.org/html/logo/downloads/HTML5_Logo_512.png"},{codigo:"0002",nombre:"CSS",estado:!0,precio:2e4,duracion:"1 mes",descripcion:"curso css",cupos:20,inscritos:0,img:"https://cdn.pixabay.com/photo/2016/11/19/23/00/css3-1841590_1280.png"},{codigo:"0003",nombre:"SASS",estado:!0,precio:4e4,duracion:"2 mes",descripcion:"curso sass",cupos:30,inscritos:0,img:"https://miro.medium.com/max/512/1*9U1toerFxB8aiFRreLxEUQ.png"},{codigo:"0004",nombre:"VUE",estado:!1,precio:5e4,duracion:"3 mes",descripcion:"curso vue",cupos:15,inscritos:0,img:"https://vuejs.org/images/logo.png"}],ue=async()=>{for(const o of ie)await a.addCourse(o)};return Ce(()=>{C.value||(C.value=a.initCoursesListener(),console.log("[Admin] initCoursesListener requested"),window.__coursesStore=a)}),ke(()=>{C.value&&typeof C.value=="function"&&(C.value(),C.value=null,console.log("[Admin] listener unsubscribed from AdminView"))}),(o,e)=>(u(),g("div",null,[n(r($e),{class:"mb-4"},{default:t(()=>[n(r(De),null,{default:t(()=>[l("div",Re,[e[13]||(e[13]=l("div",null,[l("h1",{class:"h2 mb-1"},"AdministraciÃ³n de Cursos"),l("p",{class:"text-muted mb-0"},"Gestiona los cursos de AdWeb Online")],-1)),l("div",Pe,[r(a).allCourses.length===0?(u(),y(r(m),{key:0,variant:"success",onClick:ue,disabled:r(a).isLoading},{default:t(()=>[...e[11]||(e[11]=[i(" ðŸš€ Agregar Cursos Iniciales ",-1)])]),_:1},8,["disabled"])):p("",!0),n(r(m),{variant:"primary",onClick:ee,disabled:r(a).isLoading,"data-cy":"open-add-form-btn",onHidden:G},{default:t(()=>[...e[12]||(e[12]=[i(" Agregar Curso ",-1)])]),_:1},8,["disabled"])])])]),_:1})]),_:1}),r(a).isLoading?(u(),g("div",Te,[n(r(we),{variant:"primary",class:"me-2"}),e[14]||(e[14]=l("span",null,"Cargando cursos...",-1))])):p("",!0),r(a).getError?(u(),y(r(F),{key:1,variant:"danger",class:"mb-4"},{default:t(()=>[i(" Error: "+c(r(a).getError),1)]),_:1})):p("",!0),K.value?(u(),y(r(F),{key:2,variant:"warning",class:"mb-4 d-flex flex-column flex-lg-row align-items-lg-center justify-content-lg-between gap-3"},{default:t(()=>[l("div",null,[l("strong",null,c($.value.length)+" curso(s) incompletos detectados.",1),e[15]||(e[15]=l("p",{class:"mb-0 small text-muted"}," Algunos registros no tienen nombre o imagen. Puedes eliminarlos para limpiar la tabla. ",-1))]),n(r(m),{variant:"warning",class:"text-nowrap",onClick:Q,disabled:L.value},{default:t(()=>[L.value?(u(),g("span",Ge)):p("",!0),e[16]||(e[16]=i(" Eliminar cursos vacÃ­os ",-1))]),_:1},8,["disabled"])]),_:1})):p("",!0),h.value?(u(),y(r(j),{key:3,class:"mb-4"},{default:t(()=>[e[18]||(e[18]=l("h2",{class:"h5 mb-3"},"GestiÃ³n de Roles",-1)),e[19]||(e[19]=l("p",{class:"text-muted small mb-3"},"Asigna permisos de administrador ingresando el correo registrado del usuario.",-1)),l("form",{onSubmit:Ae(J,["prevent"]),class:"d-flex flex-column flex-md-row gap-2 align-items-md-center"},[Se(l("input",{"onUpdate:modelValue":e[0]||(e[0]=s=>_.value=s),type:"email",class:"form-control",placeholder:"correo@dominio.com",required:""},null,512),[[_e,_.value,void 0,{trim:!0}]]),n(r(m),{type:"submit",variant:"dark",disabled:V.value},{default:t(()=>[V.value?(u(),g("span",je)):p("",!0),e[17]||(e[17]=i(" Conceder administrador ",-1))]),_:1},8,["disabled"])],32),v.value?(u(),y(r(F),{key:0,variant:v.value.type,class:"mt-3 mb-0",dismissible:"",onDismissed:e[1]||(e[1]=s=>v.value=null)},{default:t(()=>[i(c(v.value.message),1)]),_:1},8,["variant"])):p("",!0)]),_:1})):p("",!0),!r(a).isLoading&&!r(a).getError?(u(),y(r(j),{key:4},{default:t(()=>[n(r(Be),{items:r(a).allCourses,fields:W,striped:"",hover:"",responsive:"",class:"mb-0"},{"cell(nombre)":t(s=>[i(c(f(s.item.nombre)?s.item.nombre:"Curso sin tÃ­tulo"),1)]),"cell(img)":t(s=>[f(s.item.img)?(u(),g("img",{key:0,src:s.item.img,alt:s.item.nombre||"Curso sin tÃ­tulo",style:{width:"50px",height:"50px","object-fit":"contain",cursor:"pointer"},class:"rounded",onClick:D=>O(s.item)},null,8,Oe)):(u(),g("div",qe," Sin imagen "))]),"cell(estado)":t(s=>[n(r(Ee),{checked:!!s.item.estado,disabled:r(a).isLoading,"onUpdate:checked":D=>Z(s.item,D),size:"sm","aria-label":"Toggle estado"},{default:t(()=>[i(c(s.item.estado?"Activo":"Inactivo"),1)]),_:2},1032,["checked","disabled","onUpdate:checked"])]),"cell(precio)":t(s=>[i(" $"+c(X(s.item.precio)),1)]),"cell(ocupacion)":t(s=>[i(c(s.item.inscritos)+"/"+c(s.item.cupos)+" ("+c(Math.round(s.item.inscritos/(s.item.cupos||1)*100)||0)+"%) ",1)]),"cell(actions)":t(s=>[n(r(Fe),{size:"sm"},{default:t(()=>[n(r(m),{variant:"outline-primary",onClick:D=>te(s.item),disabled:r(a).isLoading,"data-cy":"edit-course-btn"},{default:t(()=>[...e[20]||(e[20]=[i("âœï¸",-1)])]),_:1},8,["onClick","disabled"]),n(r(m),{variant:"outline-danger",onClick:D=>ae(s.item),disabled:r(a).isLoading,"data-cy":"delete-course-btn"},{default:t(()=>[...e[21]||(e[21]=[i("ðŸ—‘ï¸",-1)])]),_:1},8,["onClick","disabled"])]),_:2},1024)]),_:1},8,["items"])]),_:1})):p("",!0),n(r(N),{modelValue:k.value,"onUpdate:modelValue":e[4]||(e[4]=s=>k.value=s),title:"Agregar Nuevo Curso",size:"lg"},{footer:t(()=>[n(r(m),{variant:"secondary",onClick:e[2]||(e[2]=()=>{console.log("[UI] Cancel Add clicked"),k.value=!1}),"data-cy":"cancel-add-btn"},{default:t(()=>[...e[22]||(e[22]=[i(" Cancelar ",-1)])]),_:1}),n(r(m),{variant:"primary",disabled:r(a).isLoading,onClick:e[3]||(e[3]=()=>{console.log("[UI] Confirm Add Form clicked"),oe()}),"data-cy":"confirm-add-btn"},{default:t(()=>[...e[23]||(e[23]=[i(" Agregar Curso ",-1)])]),_:1},8,["disabled"])]),default:t(()=>[n(Me,{course:b.value,onUpdateCourse:Y},null,8,["course"])]),_:1},8,["modelValue"]),n(r(N),{modelValue:w.value,"onUpdate:modelValue":e[6]||(e[6]=s=>w.value=s),title:"Confirmar",centered:""},{footer:t(()=>[n(r(m),{variant:"secondary",onClick:e[5]||(e[5]=s=>w.value=!1),"data-cy":"cancel-confirm-add-btn"},{default:t(()=>[...e[24]||(e[24]=[i("Cancelar",-1)])]),_:1}),n(r(m),{variant:"primary",onClick:se,disabled:r(a).isLoading,"data-cy":"confirm-add-course-btn"},{default:t(()=>[r(a).isLoading?(u(),g("span",He)):p("",!0),e[25]||(e[25]=i(" Agregar Curso ",-1))]),_:1},8,["disabled"])]),default:t(()=>[e[26]||(e[26]=l("p",null,"Â¿Deseas agregar este curso?",-1))]),_:1},8,["modelValue"]),n(r(N),{modelValue:B.value,"onUpdate:modelValue":e[7]||(e[7]=s=>B.value=s),title:"InformaciÃ³n del curso",size:"sm",centered:"","hide-footer":"","data-cy":"course-image-modal"},{default:t(()=>[S.value?(u(),g("div",he,[l("p",null,[e[27]||(e[27]=l("strong",null,"Nombre:",-1)),i(" "+c(S.value.nombre),1)]),l("p",null,[e[28]||(e[28]=l("strong",null,"Fecha de inicio:",-1)),i(" "+c(H(S.value.fechaInicio)),1)]),l("p",null,[e[29]||(e[29]=l("strong",null,"Cupos disponibles:",-1)),i(" "+c(q(S.value)),1)])])):(u(),g("div",Je,[...e[30]||(e[30]=[l("p",null,"Sin informaciÃ³n del curso",-1)])]))]),_:1},8,["modelValue"]),n(r(N),{modelValue:x.value,"onUpdate:modelValue":e[9]||(e[9]=s=>x.value=s),title:"Confirmar EliminaciÃ³n",centered:"","data-cy":"confirm-delete-modal"},{footer:t(()=>[n(r(m),{variant:"secondary",onClick:e[8]||(e[8]=s=>x.value=!1),"data-cy":"cancel-delete-btn"},{default:t(()=>[...e[33]||(e[33]=[i(" Cancelar ",-1)])]),_:1}),n(r(m),{variant:"danger",disabled:r(a).isLoading,onClick:le,"data-cy":"confirm-delete-btn"},{default:t(()=>[r(a).isLoading?(u(),g("span",Ke)):p("",!0),e[34]||(e[34]=i(" SÃ­, Borrar ",-1))]),_:1},8,["disabled"])]),default:t(()=>[l("p",null,[e[31]||(e[31]=i("Â¿Realmente deseas eliminar el curso ",-1)),l("strong",null,c(A.value?.nombre),1),e[32]||(e[32]=i("?",-1))])]),_:1},8,["modelValue"]),n(r(N),{modelValue:M.value,"onUpdate:modelValue":e[10]||(e[10]=s=>M.value=s),title:"OperaciÃ³n exitosa",centered:"","ok-only":"","ok-title":"Aceptar"},{default:t(()=>[l("p",Qe,c(T.value),1)]),_:1},8,["modelValue"])]))}},to=be(We,[["__scopeId","data-v-41603cab"]]);export{to as default};
